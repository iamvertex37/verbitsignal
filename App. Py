from flask import Flask, request, jsonify
import requests
import os
import telebot
import threading
import time
from datetime import datetime

app = Flask(__name__)

# ===== ØªÙ†Ø¸ÛŒÙ…Ø§Øª =====
TELEGRAM_TOKEN = os.environ.get('TELEGRAM_TOKEN', '8088956953:AAHk4a2iCMucZj59lrqOQHczypTOyvGSR5Y')
TELEGRAM_CHANNEL = os.environ.get('TELEGRAM_CHANNEL', '@verbitsignals')
WEBHOOK_SECRET = os.environ.get('WEBHOOK_SECRET', 'crypto-signal-secret-2024')
ADMIN_ID = os.environ.get('ADMIN_ID', '')

# ===== Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… =====
bot = telebot.TeleBot(TELEGRAM_TOKEN)

def start_bot():
    """Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…"""
    @bot.message_handler(commands=['start'])
    def send_welcome(message):
        user = message.from_user
        welcome = f"""
ğŸ¤– Ø³Ù„Ø§Ù… {user.first_name}!
Ø±Ø¨Ø§Øª Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ø±ÛŒÙ¾ØªÙˆ ÙØ¹Ø§Ù„ Ø§Ø³Øª.

ğŸ”— Ú©Ø§Ù†Ø§Ù„: {TELEGRAM_CHANNEL}
ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù†Ù„Ø§ÛŒÙ†
â° Ø²Ù…Ø§Ù†: {datetime.now().strftime('%H:%M')}

ğŸ“ Ø¯Ø³ØªÙˆØ±Ø§Øª:
/start - Ø±Ø§Ù‡Ù†Ù…Ø§
/test - Ø§Ø±Ø³Ø§Ù„ Ø³ÛŒÚ¯Ù†Ø§Ù„ ØªØ³Øª
/status - ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³
/webhook - Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„
/stats - Ø¢Ù…Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯

ğŸ’ Ù…ÙˆÙÙ‚ Ùˆ Ù¾Ø±Ø³ÙˆØ¯ Ø¨Ø§Ø´ÛŒØ¯!
"""
        bot.reply_to(message, welcome)
    
    @bot.message_handler(commands=['test'])
    def test_signal(message):
        if str(message.from_user.id) != ADMIN_ID:
            bot.reply_to(message, "âŒ ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØ³Øª Ú©Ù†Ø¯")
            return
        
        # Ø§Ø±Ø³Ø§Ù„ Ø³ÛŒÚ¯Ù†Ø§Ù„ ØªØ³Øª
        send_signal_to_channel(
            symbol="BTC/USDT",
            signal_type="BUY",
            price=45230.50,
            rsi=58.5,
            timeframe="15"
        )
        bot.reply_to(message, "âœ… Ø³ÛŒÚ¯Ù†Ø§Ù„ ØªØ³Øª Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯")
    
    @bot.message_handler(commands=['status'])
    def status(message):
        status_msg = f"""
ğŸ“Š **ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³**:
â”œ ğŸ¤– Ø±Ø¨Ø§Øª: Ø¢Ù†Ù„Ø§ÛŒÙ†
â”œ ğŸ“¢ Ú©Ø§Ù†Ø§Ù„: {TELEGRAM_CHANNEL}
â”œ ğŸ“¡ ÙˆØ¨â€ŒÙ‡ÙˆÚ©: ÙØ¹Ø§Ù„
â”œ â° Ø¢Ù¾â€ŒØªØ§ÛŒÙ…: Û±Û°Û°Ùª
â”œ ğŸ”— Ø³Ø±ÙˆÛŒØ³: {os.environ.get('RENDER_EXTERNAL_URL', 'localhost')}
â”” ğŸ•’ Ø²Ù…Ø§Ù†: {datetime.now().strftime('%Y-%m-%d %H:%M')}
"""
        bot.reply_to(message, status_msg)
    
    @bot.message_handler(commands=['webhook'])
    def webhook_info(message):
        webhook_url = f"https://{os.environ.get('RENDER_EXTERNAL_HOSTNAME', 'localhost')}/webhook"
        info = f"""
ğŸ“¡ **ØªÙ†Ø¸ÛŒÙ…Ø§Øª TradingView Webhook:**

**URL:**
